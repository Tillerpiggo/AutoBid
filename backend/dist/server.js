(()=>{"use strict";var e={433:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t},s=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((o=o.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const d=i(n(422)),u=a(n(185));t.default=class{constructor(){u.default.connect(process.env.MONGODB_URI)}getAllUsers(){return s(this,void 0,void 0,(function*(){return yield d.default.find({})}))}getUserByEmail(e){return s(this,void 0,void 0,(function*(){return yield d.default.findOne({email:e})}))}getUserById(e){return s(this,void 0,void 0,(function*(){return yield d.default.findById(e)}))}createUser(e,t){return s(this,void 0,void 0,(function*(){const n=new d.default({email:e,timezone:t,emailSendTime:"09:00",daysBeforeEmailSend:14,hasAddedContact:!1});return yield n.save(),n}))}addContactToUser(e,t,n,o){return s(this,void 0,void 0,(function*(){const r=yield this.getUserById(e),i=new d.Contact({name:t,birthdayDay:n,birthdayMonth:o,persona:"None"});return r.contacts.push(i),r.hasAddedContact=!0,yield r.save(),r}))}updateContact(e,t,n,o,r,i){return s(this,void 0,void 0,(function*(){console.log(`Updating contact with ID ${t} for user with ID ${e}`);const s=yield d.default.findById(e);if(!s)return void console.error(`User with ID ${e} not found`);const a=s.contacts.find((e=>e._id.toString()===t));if(a)return n&&(console.log(`Updating name from ${a.name} to ${n}`),a.name=n,console.log(`Name has been updated to ${a.name}`)),console.log(`Updating birthday day to ${o}`),a.birthdayDay=o,console.log(`Birthday day has been updated to ${a.birthdayDay}`),console.log(`Updating birthday month to ${r}`),a.birthdayMonth=r,console.log(`Birthday month has been updated to ${a.birthdayMonth}`),console.log(`Updating persona to ${i}`),a.persona=i,console.log(`Persona has been updated to ${a.persona}`),yield s.save(),console.log(`User with ID ${e} updated successfully`),s;console.error(`Contact with ID ${t} not found`)}))}deleteUser(e){return s(this,void 0,void 0,(function*(){return yield d.default.findByIdAndDelete(e)}))}deleteContact(e,t){return s(this,void 0,void 0,(function*(){const n=yield d.default.findById(e);if(!n)throw new Error("User not found");return n.contacts=n.contacts.filter((e=>e._id.toString()!==t)),yield n.save(),n}))}updateUser(e,t,n,o){return s(this,void 0,void 0,(function*(){const r=yield d.default.findById(e);if(r)return r.timezone=t,r.emailSendTime=n,r.daysBeforeEmailSend=o,yield r.save(),console.log(`User with ID ${e} updated successfully`),r;console.error(`User with ID ${e} not found`)}))}}},369:(e,t,n)=>{const o=n(748);e.exports=class{isTargetDay(e,t,n,r){if(e<1||e>31)throw new Error("Invalid day");if(t<1||t>12)throw new Error("Invalid month");if(!o.DateTime.fromObject({},{zone:r}).isValid)throw new Error("Invalid timezone");const i=o.DateTime.now().setZone(r).plus({days:n});return console.log(`targetDate: ${i.day} ${i.month}`),i.day===e&&i.month===t}}},413:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(344)),s=r(n(369)),a=n(769)(process.env.MAILCHIMP_API_KEY);t.default=class{constructor(e){this.getUserList=e,this.dateManager=new s.default}emailForContact(e){switch(e){case"Home Goods Lover":return"Check out our latest collection of home goods!";case"The Active Person":return"Explore our new range of sports equipment and activewear!";case"In The Kitchen":return"Discover our fresh selection of kitchen appliances and utensils!";case"Cocktail & Beverage Enthusiast":return"Try our new collection of cocktails and beverages!";case"Self care aficionado":return"Treat yourself with our new self-care and wellness products!";case"Game Night":return"Game night just got better with our new board games!";case"All Things Functional":return"Boost your productivity with our new range of functional items!";default:return"Have a look at our latest items!"}}sendEmail(e,t,n){return o(this,void 0,void 0,(function*(){try{return yield a.messages.send({message:{from_email:process.env.MAILCHIMP_FROM_EMAIL,to:[{email:e}],subject:t,text:n}})}catch(e){console.error("Error sending email:",e)}}))}getEmailsToSendToday(){return o(this,void 0,void 0,(function*(){const e=[];try{const t=yield this.getUserList();for(const n of t)for(const t of n.contacts)this.dateManager.isTargetDay(t.birthdayDay,t.birthdayMonth,n.daysBeforeEmailSend,n.timezone)?(console.log(`It's ${t.name}'s birthday today in the user's timezone!`),e.push({to:n.email,subject:`It's ${t.name}'s Birthday Today!`,message:`Don't forget to wish ${t.name} a happy birthday!\n\n${this.emailForContact(t.persona)}`})):console.log(`It's not ${t.name}'s birthday today in the user's timezone.`);return e}catch(e){console.error("Error getting emails to send:",e)}}))}sendEmailsForToday(){return o(this,void 0,void 0,(function*(){const e=yield this.getEmailsToSendToday();if(e)for(const t of e)yield this.sendEmail(t.to,t.subject,t.message),yield new Promise((e=>setTimeout(e,5e3)))}))}sendEmailsNow(){this.sendEmailsForToday()}startDailyJob(){i.default.scheduleJob("0 16 * * *",(()=>o(this,void 0,void 0,(function*(){console.log("sending emails"),yield this.sendEmailsForToday()}))))}}},755:function(e,t){var n=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ContactController=void 0,t.ContactController=e=>({addContact:(t,o)=>n(void 0,void 0,void 0,(function*(){const{userId:n}=t.params,{name:r,birthdayDay:i,birthdayMonth:s}=t.body,a=yield e.addContactToUser(n,r,i,s);if(!a)return o.status(404).send({error:"User not found"});o.send({message:"Contact added",user:a})})),updateContact:(t,o)=>n(void 0,void 0,void 0,(function*(){const{userId:n,contactId:r}=t.params,{name:i,birthdayDay:s,birthdayMonth:a,persona:d}=t.body,u=yield e.updateContact(n,r,i,s,a,d);if(!u)return o.status(404).send({error:"User not found"});o.send({message:"Contact updated",user:u})})),deleteContact:(t,o)=>n(void 0,void 0,void 0,(function*(){const{userId:n,contactId:r}=t.params,i=yield e.deleteContact(n,r);if(!i)return o.status(404).send({error:"User not found"});o.send({message:"Contact deleted",user:i})}))})},954:function(e,t){var n=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserController=void 0,t.UserController=e=>({registerUser:(t,o)=>n(void 0,void 0,void 0,(function*(){const{email:n,timezone:r}=t.body,i=yield e.getUserByEmail(n.toLowerCase());if(i)return o.send({message:"existing user",user:i});const s=yield e.createUser(n.toLowerCase(),r);o.send({message:"new user",user:s})})),getUserById:(t,o)=>n(void 0,void 0,void 0,(function*(){const{userId:n}=t.params,r=yield e.getUserById(n);if(!r)return o.status(404).send({error:"User not found"});o.send({user:r})})),updateUser:(t,o)=>n(void 0,void 0,void 0,(function*(){const{userId:n}=t.params,{timezone:r,emailSendTime:i,daysBeforeEmailSend:s}=t.body;try{const t=yield e.updateUser(n,r,i,s);if(!t)return o.status(404).send({error:"User not found"});o.send({message:"User updated",user:t})}catch(e){console.error(e),o.status(500).send({error:"An error occurred while updating the user"})}})),deleteUser:(t,o)=>n(void 0,void 0,void 0,(function*(){const{userId:n}=t.params;try{const t=yield e.deleteUser(n);if(!t)return void o.status(404).send({message:"User not found"});o.send({message:"User deleted successfully",user:t})}catch(e){console.error(e),o.status(500).send({message:"An error occurred while deleting the user"})}}))})},422:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Contact=void 0;const s=i(n(185)),a=new s.Schema({name:{type:String,required:!0},birthdayDay:{type:Number,required:!0},birthdayMonth:{type:Number,required:!0},persona:{type:String,required:!0}}),d=new s.Schema({email:{type:String,required:!0,unique:!0},timezone:{type:String,required:!0},emailSendTime:{type:String,required:!0,match:/^([01]\d|2[0-3]):([0-5]\d)$/},daysBeforeEmailSend:{type:Number,required:!0},contacts:[a],hasAddedContact:{type:Boolean,required:!0}});d.virtual("id").get((function(){return this._id.toHexString()})),d.set("toJSON",{virtuals:!0}),a.virtual("id").get((function(){return this._id.toHexString()})),a.set("toJSON",{virtuals:!0}),d.methods.getcontact=function(e){return this.contacts.find((t=>t._id.toString()===e))},t.Contact=s.default.model("Contact",a),t.default=s.default.model("User",d)},505:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(860));r(n(142)).default.config();const s=r(n(413)),a=r(n(433)),d=n(954),u=n(755),c=(0,i.default)();c.use(i.default.json());const l=n(582);c.use(l());const f=process.env.PORT||3e3;c.listen(f,(()=>{console.log(`Server is listening on port ${f}`)}));const h=new a.default,y=new s.default(h.getAllUsers);y.startDailyJob();const m=(0,d.UserController)(h),v=(0,u.ContactController)(h);c.post("/register",m.registerUser),c.get("/users/:userId",m.getUserById),c.put("/users/:userId",m.updateUser),c.delete("/users/:userId",m.deleteUser),c.post("/users/:userId/contacts",v.addContact),c.put("/users/:userId/contacts/:contactId",v.updateContact),c.delete("/users/:userId/contacts/:contactId",v.deleteContact),c.post("/debug/send-emails",((e,t)=>o(void 0,void 0,void 0,(function*(){y.sendEmailsNow(),t.send({message:"Emails sent"})}))))},769:e=>{e.exports=require("@mailchimp/mailchimp_transactional/src/index.js")},582:e=>{e.exports=require("cors")},142:e=>{e.exports=require("dotenv")},860:e=>{e.exports=require("express")},748:e=>{e.exports=require("luxon")},185:e=>{e.exports=require("mongoose")},344:e=>{e.exports=require("node-schedule")}},t={};!function n(o){var r=t[o];if(void 0!==r)return r.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,n),i.exports}(505)})();