(()=>{"use strict";var e={433:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{d(r.next(e))}catch(e){s(e)}}function a(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}d((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const d=s(n(551)),u=a(n(185));t.default=class{constructor(){u.default.connect(process.env.MONGODB_URI)}getAllUsers(){return i(this,void 0,void 0,(function*(){return yield d.default.find({})}))}getUserByEmail(e){return i(this,void 0,void 0,(function*(){return yield d.default.findOne({email:e})}))}getUserById(e){return i(this,void 0,void 0,(function*(){return yield d.default.findById(e)}))}createUser(e,t){return i(this,void 0,void 0,(function*(){const n=new d.default({email:e,timezone:t,emailSendTime:"09:00",daysBeforeEmailSend:14,hasAddedContact:!1});return yield n.save(),n}))}addContactToUser(e,t,n,r){return i(this,void 0,void 0,(function*(){const o=yield this.getUserById(e),s=new d.Contact({name:t,birthdayDay:n,birthdayMonth:r,persona:"None"});return o.contacts.push(s),o.hasAddedContact=!0,yield o.save(),o}))}updateContact(e,t,n,r,o,s){return i(this,void 0,void 0,(function*(){console.log(`Updating contact with ID ${t} for user with ID ${e}`);const i=yield d.default.findById(e);if(!i)return void console.error(`User with ID ${e} not found`);const a=i.contacts.find((e=>e._id.toString()===t));if(a)return n&&(console.log(`Updating name from ${a.name} to ${n}`),a.name=n),a.birthdayDay=r,a.birthdayMonth=o,a.persona=s,yield i.save(),console.log(`User with ID ${e} updated successfully`),i;console.error(`Contact with ID ${t} not found`)}))}deleteUser(e){return i(this,void 0,void 0,(function*(){return yield d.default.findByIdAndDelete(e)}))}deleteContact(e,t){return i(this,void 0,void 0,(function*(){const n=yield d.default.findById(e);if(!n)throw new Error("User not found");return n.contacts=n.contacts.filter((e=>e._id.toString()!==t)),yield n.save(),n}))}updateUser(e,t,n,r){return i(this,void 0,void 0,(function*(){const o=yield d.default.findById(e);if(o)return o.timezone=t,o.emailSendTime=n,o.daysBeforeEmailSend=r,yield o.save(),console.log(`User with ID ${e} updated successfully`),o;console.error(`User with ID ${e} not found`)}))}getPersonaByName(e){return i(this,void 0,void 0,(function*(){return yield d.Persona.findOne({name:e})}))}createPersona(e){return i(this,void 0,void 0,(function*(){const t=new d.Persona({name:e});return yield t.save(),t}))}getAllPersonas(){return i(this,void 0,void 0,(function*(){return yield d.Persona.find({})}))}updatePersona(e,t){return i(this,void 0,void 0,(function*(){const n=yield d.Persona.findById(e);if(n)return n.name=t,yield n.save(),console.log(`Persona with ID ${e} updated successfully`),n;console.error(`Persona with ID ${e} not found`)}))}deletePersona(e){return i(this,void 0,void 0,(function*(){return yield d.Persona.findByIdAndDelete(e)}))}}},369:(e,t,n)=>{const r=n(748);e.exports=class{isTargetDay(e,t,n,o){if(e<1||e>31)throw new Error("Invalid day");if(t<1||t>12)throw new Error("Invalid month");if(!r.DateTime.fromObject({},{zone:o}).isValid)throw new Error("Invalid timezone");const s=r.DateTime.now().setZone(o).plus({days:n});return console.log(`targetDate: ${s.day} ${s.month}`),s.day===e&&s.month===t}}},413:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{d(r.next(e))}catch(e){s(e)}}function a(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}d((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(n(344)),i=o(n(369)),a=n(769)(process.env.MAILCHIMP_API_KEY);t.default=class{constructor(e){this.getUserList=e,this.dateManager=new i.default}emailForContact(e){switch(e){case"Home Goods Lover":return"Check out our latest collection of home goods!";case"The Active Person":return"Explore our new range of sports equipment and activewear!";case"In The Kitchen":return"Discover our fresh selection of kitchen appliances and utensils!";case"Cocktail & Beverage Enthusiast":return"Try our new collection of cocktails and beverages!";case"Self care aficionado":return"Treat yourself with our new self-care and wellness products!";case"Game Night":return"Game night just got better with our new board games!";case"All Things Functional":return"Boost your productivity with our new range of functional items!";default:return"Have a look at our latest items!"}}sendEmail(e,t,n){return r(this,void 0,void 0,(function*(){try{return yield a.messages.send({message:{from_email:process.env.MAILCHIMP_FROM_EMAIL,to:[{email:e}],subject:t,text:n}})}catch(e){console.error("Error sending email:",e)}}))}getEmailsToSendToday(){return r(this,void 0,void 0,(function*(){const e=[];try{const t=yield this.getUserList();for(const n of t)for(const t of n.contacts)this.dateManager.isTargetDay(t.birthdayDay,t.birthdayMonth,n.daysBeforeEmailSend,n.timezone)?(console.log(`It's ${t.name}'s birthday today in the user's timezone!`),e.push({to:n.email,subject:`It's ${t.name}'s Birthday Today!`,message:`Don't forget to wish ${t.name} a happy birthday!\n\n${this.emailForContact(t.persona)}`})):console.log(`It's not ${t.name}'s birthday today in the user's timezone.`);return e}catch(e){console.error("Error getting emails to send:",e)}}))}sendEmailsForToday(){return r(this,void 0,void 0,(function*(){const e=yield this.getEmailsToSendToday();if(e)for(const t of e)yield this.sendEmail(t.to,t.subject,t.message),yield new Promise((e=>setTimeout(e,5e3)))}))}sendEmailsNow(){this.sendEmailsForToday()}startDailyJob(){s.default.scheduleJob("0 16 * * *",(()=>r(this,void 0,void 0,(function*(){console.log("sending emails"),yield this.sendEmailsForToday()}))))}}},755:function(e,t){var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{d(r.next(e))}catch(e){s(e)}}function a(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ContactController=void 0,t.ContactController=e=>({addContact:(t,r)=>n(void 0,void 0,void 0,(function*(){const{userId:n}=t.params,{name:o,birthdayDay:s,birthdayMonth:i}=t.body,a=yield e.addContactToUser(n,o,s,i);if(!a)return r.status(404).send({error:"User not found"});r.send({message:"Contact added",user:a})})),updateContact:(t,r)=>n(void 0,void 0,void 0,(function*(){const{userId:n,contactId:o}=t.params,{name:s,birthdayDay:i,birthdayMonth:a,persona:d}=t.body,u=yield e.updateContact(n,o,s,i,a,d);if(!u)return r.status(404).send({error:"User not found"});r.send({message:"Contact updated",user:u})})),deleteContact:(t,r)=>n(void 0,void 0,void 0,(function*(){const{userId:n,contactId:o}=t.params,s=yield e.deleteContact(n,o);if(!s)return r.status(404).send({error:"User not found"});r.send({message:"Contact deleted",user:s})}))})},447:function(e,t){var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{d(r.next(e))}catch(e){s(e)}}function a(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PersonaController=void 0,t.PersonaController=e=>({addPersona:(t,r)=>n(void 0,void 0,void 0,(function*(){const{name:n}=t.body,o=yield e.getPersonaByName(n);if(o)return r.send({message:"existing persona",persona:o});const s=yield e.createPersona(n);r.send({message:"new persona",persona:s})})),getAllPersona:(t,r)=>n(void 0,void 0,void 0,(function*(){const t=yield e.getAllPersonas();r.send({personas:t})})),editPersona:(t,r)=>n(void 0,void 0,void 0,(function*(){const{personaId:n}=t.params,{name:o}=t.body;try{const t=yield e.updatePersona(n,o);if(!t)return r.status(404).send({error:"Persona not found"});r.send({message:"Persona updated",persona:t})}catch(e){console.error(e),r.status(500).send({error:"An error occurred while updating the persona"})}})),deletePersona:(t,r)=>n(void 0,void 0,void 0,(function*(){const{personaId:n}=t.params;try{const t=yield e.deletePersona(n);if(!t)return void r.status(404).send({message:"Persona not found"});r.send({message:"Persona deleted successfully",persona:t})}catch(e){console.error(e),r.status(500).send({message:"An error occurred while deleting the persona"})}}))})},954:function(e,t){var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{d(r.next(e))}catch(e){s(e)}}function a(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserController=void 0,t.UserController=e=>({registerUser:(t,r)=>n(void 0,void 0,void 0,(function*(){const{email:n,timezone:o}=t.body,s=yield e.getUserByEmail(n.toLowerCase());if(s)return r.send({message:"existing user",user:s});const i=yield e.createUser(n.toLowerCase(),o);r.send({message:"new user",user:i})})),getUserById:(t,r)=>n(void 0,void 0,void 0,(function*(){const{userId:n}=t.params,o=yield e.getUserById(n);if(!o)return r.status(404).send({error:"User not found"});r.send({user:o})})),updateUser:(t,r)=>n(void 0,void 0,void 0,(function*(){const{userId:n}=t.params,{timezone:o,emailSendTime:s,daysBeforeEmailSend:i}=t.body;try{const t=yield e.updateUser(n,o,s,i);if(!t)return r.status(404).send({error:"User not found"});r.send({message:"User updated",user:t})}catch(e){console.error(e),r.status(500).send({error:"An error occurred while updating the user"})}})),deleteUser:(t,r)=>n(void 0,void 0,void 0,(function*(){const{userId:n}=t.params;try{const t=yield e.deleteUser(n);if(!t)return void r.status(404).send({message:"User not found"});r.send({message:"User deleted successfully",user:t})}catch(e){console.error(e),r.status(500).send({message:"An error occurred while deleting the user"})}}))})},551:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Contact=t.Product=t.Persona=void 0;const i=s(n(185)),a=new i.Schema({name:{type:String,required:!0},birthdayDay:{type:Number,required:!0},birthdayMonth:{type:Number,required:!0},persona:{type:String,required:!0}}),d=new i.Schema({email:{type:String,required:!0,unique:!0},timezone:{type:String,required:!0},emailSendTime:{type:String,required:!0,match:/^([01]\d|2[0-3]):([0-5]\d)$/},daysBeforeEmailSend:{type:Number,required:!0},contacts:[a],hasAddedContact:{type:Boolean,required:!0}});d.virtual("id").get((function(){return this._id.toHexString()})),d.set("toJSON",{virtuals:!0}),a.virtual("id").get((function(){return this._id.toHexString()})),a.set("toJSON",{virtuals:!0}),d.methods.getcontact=function(e){return this.contacts.find((t=>t._id.toString()===e))};const u=new i.Schema({name:{type:String,required:!0}}),c=new i.Schema({persona:{type:String,required:!0},name:{type:String,required:!0},brand:{type:String,required:!0},price:{type:Number,required:!0},image:{type:String,required:!0}});u.virtual("id").get((function(){return this._id.toHexString()})),u.set("toJSON",{virtuals:!0}),c.virtual("id").get((function(){return this._id.toHexString()})),c.set("toJSON",{virtuals:!0}),t.Persona=i.default.model("Persona",u),t.Product=i.default.model("Product",c),t.Contact=i.default.model("Contact",a),t.default=i.default.model("User",d)},505:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{d(r.next(e))}catch(e){s(e)}}function a(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}d((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(n(860));o(n(142)).default.config();const i=o(n(413)),a=o(n(433)),d=n(954),u=n(755),c=n(447),l=(0,s.default)();l.use(s.default.json());const f=n(582);l.use(f());const h=process.env.PORT||3e3;l.listen(h,(()=>{console.log(`Server is listening on port ${h}`)}));const y=new a.default,v=new i.default(y.getAllUsers);v.startDailyJob();const m=(0,d.UserController)(y),p=(0,u.ContactController)(y),g=(0,c.PersonaController)(y);l.post("/register",m.registerUser),l.get("/users/:userId",m.getUserById),l.put("/users/:userId",m.updateUser),l.delete("/users/:userId",m.deleteUser),l.post("/users/:userId/contacts",p.addContact),l.put("/users/:userId/contacts/:contactId",p.updateContact),l.delete("/users/:userId/contacts/:contactId",p.deleteContact),l.post("/admin/personas",g.addPersona),l.get("/admin/personas",g.getAllPersona),l.put("/admin/personas/:personaId",g.editPersona),l.delete("/admin/personas/:personaId",g.deletePersona),l.post("/debug/send-emails",((e,t)=>r(void 0,void 0,void 0,(function*(){v.sendEmailsNow(),t.send({message:"Emails sent"})}))))},769:e=>{e.exports=require("@mailchimp/mailchimp_transactional/src/index.js")},582:e=>{e.exports=require("cors")},142:e=>{e.exports=require("dotenv")},860:e=>{e.exports=require("express")},748:e=>{e.exports=require("luxon")},185:e=>{e.exports=require("mongoose")},344:e=>{e.exports=require("node-schedule")}},t={};!function n(r){var o=t[r];if(void 0!==o)return o.exports;var s=t[r]={exports:{}};return e[r].call(s.exports,s,s.exports,n),s.exports}(505)})();