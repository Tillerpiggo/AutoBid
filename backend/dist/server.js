(()=>{"use strict";var e={433:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t},s=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function d(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}a((o=o.apply(e,t||[])).next())}))},d=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=i(n(422)),u=d(n(185)),c=d(n(362));t.default=class{constructor(){u.default.connect(process.env.MONGODB_URI)}getAllUsers(){return s(this,void 0,void 0,(function*(){return yield a.default.find({})}))}getUserByEmail(e){return s(this,void 0,void 0,(function*(){return yield a.default.findOne({email:e})}))}getUserById(e){return s(this,void 0,void 0,(function*(){return yield a.default.findById(e)}))}createUser(e,t){return s(this,void 0,void 0,(function*(){const n=new a.default({email:e,timezone:t,emailSendTime:"09:00"});return yield n.save(),n}))}addContactToUser(e,t,n){return s(this,void 0,void 0,(function*(){const o=yield this.getUserById(e),r=new a.Contact({name:t,birthday:n});return o.contacts.push(r),yield o.save(),o}))}updateContact(e,t,n,o){return s(this,void 0,void 0,(function*(){console.log(`Updating contact with ID ${t} for user with ID ${e}`);const r=yield a.default.findById(e);if(!r)return void console.error(`User with ID ${e} not found`);const i=r.contacts.find((e=>e._id.toString()===t));if(i){if(n&&(console.log(`Updating name from ${i.name} to ${n}`),i.name=n),o){console.log(`Updating birthday from ${i.birthday}`);const e=c.default.tz(o,"YYYY-MM-DD",r.timezone).startOf("day").toDate();console.log(`to ${e}`),i.birthday=e}return yield r.save(),console.log(`User with ID ${e} updated successfully`),r}console.error(`Contact with ID ${t} not found`)}))}deleteUser(e){return s(this,void 0,void 0,(function*(){return yield a.default.findByIdAndDelete(e)}))}deleteContact(e,t){return s(this,void 0,void 0,(function*(){const n=yield a.default.findById(e);if(!n)throw new Error("User not found");return n.contacts=n.contacts.filter((e=>e._id.toString()!==t)),yield n.save(),n}))}updateUser(e,t,n){return s(this,void 0,void 0,(function*(){const o=yield a.default.findById(e);if(o)return o.timezone=t,o.emailSendTime=n,yield o.save(),console.log(`User with ID ${e} updated successfully`),o;console.error(`User with ID ${e} not found`)}))}}},413:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function d(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}a((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(344)),s=r(n(362)),d=n(769)(process.env.MAILCHIMP_API_KEY);t.default=class{constructor(e){this.getUserList=e}sendEmail(e,t,n){return o(this,void 0,void 0,(function*(){try{return yield d.messages.send({message:{from_email:process.env.MAILCHIMP_FROM_EMAIL,to:[{email:e}],subject:t,text:n}})}catch(e){console.error("Error sending email:",e)}}))}getEmailsToSendToday(){return o(this,void 0,void 0,(function*(){const e=[];try{const t=yield this.getUserList();for(const n of t){const t=(0,s.default)().tz(n.timezone);console.log(`User's timezone is ${n.timezone}, and the current date/time in their timezone is ${t.format()}`);for(const o of n.contacts){let r=s.default.utc(o.birthday).tz(n.timezone);r.year(t.year()).month(t.month()).date(t.date()),console.log(`Contact's birthday is ${o.birthday}, and in the user's timezone, this is ${r.format()}`),r.isSame(t,"day")?(console.log(`It's ${o.name}'s birthday today in the user's timezone!`),e.push({to:n.email,subject:`It's ${o.name}'s Birthday Today!`,message:`Don't forget to wish ${o.name} a happy birthday!`})):console.log(`It's not ${o.name}'s birthday today in the user's timezone.`)}}return e}catch(e){console.error("Error getting emails to send:",e)}}))}sendEmailsForToday(){return o(this,void 0,void 0,(function*(){const e=yield this.getEmailsToSendToday();if(e)for(const t of e)yield this.sendEmail(t.to,t.subject,t.message),yield new Promise((e=>setTimeout(e,5e3)))}))}sendEmailsNow(){this.sendEmailsForToday()}startDailyJob(){i.default.scheduleJob("26 19 * * *",(()=>o(this,void 0,void 0,(function*(){console.log("sending emails"),yield this.sendEmailsForToday()}))))}}},755:function(e,t){var n=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function d(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ContactController=void 0,t.ContactController=e=>({addContact:(t,o)=>n(void 0,void 0,void 0,(function*(){const{userId:n}=t.params,{name:r,birthday:i}=t.body,s=yield e.addContactToUser(n,r,i);if(!s)return o.status(404).send({error:"User not found"});o.send({message:"Contact added",user:s})})),updateContact:(t,o)=>n(void 0,void 0,void 0,(function*(){const{userId:n,contactId:r}=t.params,{name:i,birthday:s}=t.body,d=yield e.updateContact(n,r,i,s);if(!d)return o.status(404).send({error:"User not found"});o.send({message:"Contact updated",user:d})})),deleteContact:(t,o)=>n(void 0,void 0,void 0,(function*(){const{userId:n,contactId:r}=t.params,i=yield e.deleteContact(n,r);if(!i)return o.status(404).send({error:"User not found"});o.send({message:"Contact deleted",user:i})}))})},954:function(e,t){var n=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function d(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserController=void 0,t.UserController=e=>({registerUser:(t,o)=>n(void 0,void 0,void 0,(function*(){const{email:n,timezone:r}=t.body,i=yield e.getUserByEmail(n.toLowerCase());if(i)return o.send({user:i});const s=yield e.createUser(n.toLowerCase(),r);o.send({user:s})})),getUserById:(t,o)=>n(void 0,void 0,void 0,(function*(){const{userId:n}=t.params,r=yield e.getUserById(n);if(!r)return o.status(404).send({error:"User not found"});o.send({user:r})})),updateUser:(t,o)=>n(void 0,void 0,void 0,(function*(){const{userId:n}=t.params,{timezone:r,emailSendTime:i}=t.body;try{const t=yield e.updateUser(n,r,i);if(!t)return o.status(404).send({error:"User not found"});o.send({message:"User updated",user:t})}catch(e){console.error(e),o.status(500).send({error:"An error occurred while updating the user"})}})),deleteUser:(t,o)=>n(void 0,void 0,void 0,(function*(){const{userId:n}=t.params;try{const t=yield e.deleteUser(n);if(!t)return void o.status(404).send({message:"User not found"});o.send({message:"User deleted successfully",user:t})}catch(e){console.error(e),o.status(500).send({message:"An error occurred while deleting the user"})}}))})},422:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Contact=void 0;const s=i(n(185)),d=new s.Schema({name:{type:String,required:!0},birthday:{type:Date,required:!0}}),a=new s.Schema({email:{type:String,required:!0,unique:!0},timezone:{type:String,required:!0},emailSendTime:{type:String,required:!0,match:/^([01]\d|2[0-3]):([0-5]\d)$/},contacts:[d]});a.virtual("id").get((function(){return this._id.toHexString()})),a.set("toJSON",{virtuals:!0}),d.virtual("id").get((function(){return this._id.toHexString()})),d.set("toJSON",{virtuals:!0}),a.methods.getcontact=function(e){return this.contacts.find((t=>t._id.toString()===e))},t.Contact=s.default.model("Contact",d),t.default=s.default.model("User",a)},505:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function d(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}a((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(860));r(n(142)).default.config();const s=r(n(413)),d=r(n(433)),a=n(954),u=n(755),c=(0,i.default)();c.use(i.default.json());const l=n(582);c.use(l());const f=process.env.PORT||3e3;c.listen(f,(()=>{console.log(`Server is listening on port ${f}`)}));const h=new d.default,y=new s.default(h.getAllUsers);y.startDailyJob();const m=(0,a.UserController)(h),v=(0,u.ContactController)(h);c.post("/register",m.registerUser),c.get("/users/:userId",m.getUserById),c.put("/users/:userId",m.updateUser),c.delete("/users/:userId",m.deleteUser),c.post("/users/:userId/contacts",v.addContact),c.put("/users/:userId/contacts/:contactId",v.updateContact),c.delete("/users/:userId/contacts/:contactId",v.deleteContact),c.post("/debug/send-emails",((e,t)=>o(void 0,void 0,void 0,(function*(){y.sendEmailsNow(),t.send({message:"Emails sent"})}))))},769:e=>{e.exports=require("@mailchimp/mailchimp_transactional/src/index.js")},582:e=>{e.exports=require("cors")},142:e=>{e.exports=require("dotenv")},860:e=>{e.exports=require("express")},362:e=>{e.exports=require("moment-timezone")},185:e=>{e.exports=require("mongoose")},344:e=>{e.exports=require("node-schedule")}},t={};!function n(o){var r=t[o];if(void 0!==r)return r.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,n),i.exports}(505)})();