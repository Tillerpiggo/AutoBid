(()=>{"use strict";var e={422:function(e,t,r){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const s=i(r(185)),d=new s.Schema({name:{type:String,required:!0},birthday:{type:Date,required:!0}}),u=new s.Schema({email:{type:String,required:!0,unique:!0},loginCode:{type:String,required:!0},loginCodeExpires:{type:Date},friends:[d]});u.methods.getFriend=function(e){return this.friends.find((t=>t._id.toString()===e))},t.default=s.default.model("User",u)},505:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{u(n.next(e))}catch(e){i(e)}}function d(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,d)}u((n=n.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(r(860)),s=o(r(185)),d=o(r(422)),u=r(294);o(r(142)).default.config();const a=(0,i.default)(),l=r(582);a.use(l()),s.default.connect("mongodb://localhost/newsletter_app"),new u.NodeMailgun,a.use(i.default.json()),a.get("/",((e,t)=>{t.send("Hello, world!")}));const f=process.env.PORT||3e3;a.listen(f,(()=>{console.log(`Server is listening on port ${f}`)})),a.post("/register",((e,t)=>n(void 0,void 0,void 0,(function*(){console.log("register called");const{email:r}=e.body;if(yield d.default.findOne({email:r}))return console.log("user already exists"),t.status(400).send({error:"User with this email already exists"});const n=Math.floor(1e5+9e5*Math.random()),o=new d.default({email:r,loginCode:n,loginCodeExpires:Date.now()+9e5});console.log("saving user"),yield o.save(),console.log("user saved"),t.send({email:r})})))),a.post("/users/:userId/friends",((e,t)=>n(void 0,void 0,void 0,(function*(){const{userId:r}=e.params,{name:n,birthday:o}=e.body,i=yield d.default.findById(r);if(!i)return t.status(404).send({error:"User not found"});const s={name:n,birthday:o};i.friends.push(s),yield i.save(),t.send({message:"Friend added",user:i});const u=i.toObject();delete u.loginCode,delete u.loginCodeExpires,t.status(201).send(u)})))),a.put("/users/:userId/friends/:friendId",((e,t)=>n(void 0,void 0,void 0,(function*(){const{userId:r,friendId:n}=e.params,{name:o,birthday:i}=e.body,s=yield d.default.findById(r);if(!s)return t.status(404).send({error:"User not found"});const u=s.friends.find((e=>e.id===n));if(!u)return t.status(404).send({error:"Friend not found"});o&&(u.name=o),i&&(u.birthday=i),yield s.save(),t.send({message:"Friend updated",user:s})})))),a.get("/users/:userId",((e,t)=>n(void 0,void 0,void 0,(function*(){const{userId:r}=e.params,n=yield d.default.findById(r);if(!n)return t.status(404).send({error:"User not found"});t.send({user:n})}))))},582:e=>{e.exports=require("cors")},142:e=>{e.exports=require("dotenv")},860:e=>{e.exports=require("express")},185:e=>{e.exports=require("mongoose")},294:e=>{e.exports=require("ts-mailgun")}},t={};!function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,r),i.exports}(505)})();