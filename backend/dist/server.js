(()=>{"use strict";var e={422:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const s=o(n(185)),d=new s.Schema({name:{type:String,required:!0},birthday:{type:Date,required:!0}}),u=new s.Schema({email:{type:String,required:!0,unique:!0},loginCode:{type:String,required:!0},loginCodeExpires:{type:Date},friends:[d]});u.methods.getFriend=function(e){return this.friends.find((t=>t._id.toString()===e))},t.default=s.default.model("User",u)},505:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function d(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=i(n(860)),s=i(n(185)),d=i(n(422)),u=n(294);i(n(142)).default.config();const a=(0,o.default)(),l=n(582);a.use(l()),s.default.connect("mongodb://localhost/newsletter_app"),new u.NodeMailgun,a.use(o.default.json()),a.get("/",((e,t)=>{t.send("Hello, world!")}));const c=process.env.PORT||3e3;a.listen(c,(()=>{console.log(`Server is listening on port ${c}`)})),a.post("/register",((e,t)=>r(void 0,void 0,void 0,(function*(){console.log("register called");const{email:n}=e.body,r=yield d.default.findOne({email:n});if(r)return console.log("Existing user: "+r),void t.send({user:r});const i=Math.floor(1e5+9e5*Math.random()),o=new d.default({email:n,loginCode:i,loginCodeExpires:Date.now()+9e5});console.log("saving user"),yield o.save(),console.log("user saved"),o.id=o._id.toString(),t.send({user:o}),console.log("user email: "+o.email),console.log("user id: "+o._id.toString())})))),a.post("/users/:userEmail/friends",((e,t)=>r(void 0,void 0,void 0,(function*(){const{userEmail:n}=e.params,{name:r,birthday:i}=e.body;console.log("finding user with email: "+n);const o=yield d.default.findOne({email:n}),s={name:r,birthday:i};o.friends.push(s),yield o.save();const u=o.toObject();u.id=u._id.toString(),delete u._id,delete u.loginCode,delete u.loginCodeExpires,t.send({message:"Friend added",userForClient:u})})))),a.put("/users/:userId/friends/:friendId",((e,t)=>r(void 0,void 0,void 0,(function*(){const{userId:n,friendId:r}=e.params,{name:i,birthday:o}=e.body,s=yield d.default.findById(n);if(!s)return t.status(404).send({error:"User not found"});const u=s.friends.find((e=>e.id===r));if(!u)return t.status(404).send({error:"Friend not found"});i&&(u.name=i),o&&(u.birthday=o),yield s.save(),t.send({message:"Friend updated",user:s})})))),a.get("/users/:userId",((e,t)=>r(void 0,void 0,void 0,(function*(){const{userId:n}=e.params,r=yield d.default.findById(n);if(!r)return t.status(404).send({error:"User not found"});t.send({user:r})}))))},582:e=>{e.exports=require("cors")},142:e=>{e.exports=require("dotenv")},860:e=>{e.exports=require("express")},185:e=>{e.exports=require("mongoose")},294:e=>{e.exports=require("ts-mailgun")}},t={};!function n(r){var i=t[r];if(void 0!==i)return i.exports;var o=t[r]={exports:{}};return e[r].call(o.exports,o,o.exports,n),o.exports}(505)})();