(()=>{"use strict";var e={433:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const d=i(n(422)),u=a(n(185));t.default=class{constructor(){u.default.connect(process.env.MONGODB_URI)}getAllUsers(){return s(this,void 0,void 0,(function*(){return yield d.default.find({})}))}getUserByEmail(e){return s(this,void 0,void 0,(function*(){return yield d.default.findOne({email:e})}))}createUser(e){return s(this,void 0,void 0,(function*(){const t=new d.default({email:e});return yield t.save(),t}))}addFriendToUser(e,t,n){return s(this,void 0,void 0,(function*(){const r=yield this.getUserByEmail(e),o=new d.Friend({name:t,birthday:n});return r.friends.push(o),yield r.save(),r}))}updateFriend(e,t,n,r){return s(this,void 0,void 0,(function*(){const o=yield d.default.findById(e),i=o.friends.find((e=>e._id.toString()===t));return n&&(i.name=n),r&&(i.birthday=new Date(r)),yield o.save(),o}))}}},413:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(344)),s=n(769)(process.env.MAILCHIMP_API_KEY);console.log("API_KEY",process.env.MAILCHIMP_API_KEY),console.log("EMAIL",process.env.MAILCHIMP_FROM_EMAIL),t.default=class{constructor(e){this.getUserList=e}sendEmail(e,t,n){return r(this,void 0,void 0,(function*(){try{const r=yield s.messages.send({message:{from_email:process.env.MAILCHIMP_FROM_EMAIL,to:[{email:e}],subject:t,text:n}});return console.log(`Response from Mailchimp: ${JSON.stringify(r)}`),r}catch(e){console.error("Error sending email:",e)}}))}getEmailsToSendToday(){return r(this,void 0,void 0,(function*(){const e=new Date,t=[];try{const n=yield this.getUserList();console.log("Users:",n);for(const r of n){console.log("User:",r);for(const n of r.friends)console.log("Friend:",n),console.log("Friend Birthday: ",n.birthday),console.log("Today: ",e),console.log("Friend Birthday Month: ",n.birthday.getMonth()),console.log("Today Month: ",e.getMonth()),console.log("Friend Birthday Date: ",n.birthday.getDate()),console.log("Today Date: ",e.getDate()),n.birthday.getMonth()===e.getMonth()&&n.birthday.getDate()===e.getDate()?(console.log(`Adding email to the list for: ${n.name}`),t.push({to:r.email,subject:`It's ${n.name}'s Birthday Today!`,message:`Don't forget to wish ${n.name} a happy birthday!`})):console.log(`No match for: ${n.name}'s birthday`)}return console.log("Final email list:",t),t}catch(e){console.error("Error getting emails to send:",e)}}))}sendEmailsForToday(){return r(this,void 0,void 0,(function*(){const e=yield this.getEmailsToSendToday();if(e)for(const t of e)yield this.sendEmail(t.to,t.subject,t.message),yield new Promise((e=>setTimeout(e,5e3)))}))}sendEmailsNow(){console.log("Sending emails now..."),this.sendEmailsForToday()}startDailyJob(){console.log("Starting daily job..."),i.default.scheduleJob("0 8 * * *",(()=>r(this,void 0,void 0,(function*(){yield this.sendEmailsForToday()}))))}}},155:function(e,t){var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.FriendController=void 0,t.FriendController=e=>({addFriend:(t,r)=>n(void 0,void 0,void 0,(function*(){const{userEmail:n}=t.params,{name:o,birthday:i}=t.body,s=yield e.addFriendToUser(n,o,i);if(!s)return r.status(404).send({error:"User not found"});r.send({message:"Friend added",user:s})})),updateFriend:(t,r)=>n(void 0,void 0,void 0,(function*(){const{userId:n,friendId:o}=t.params,{name:i,birthday:s}=t.body,a=yield e.updateFriend(n,o,i,s);if(!a)return r.status(404).send({error:"User not found"});r.send({message:"Friend updated",user:a})}))})},954:function(e,t){var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserController=void 0,t.UserController=e=>({registerUser:(t,r)=>n(void 0,void 0,void 0,(function*(){const{email:n}=t.body,o=yield e.getUserByEmail(n);if(o)return r.send({user:o});const i=yield e.createUser(n);r.send({user:i})})),getUserByEmail:(t,r)=>n(void 0,void 0,void 0,(function*(){const{email:n}=t.params,o=yield e.getUserByEmail(n);if(!o)return r.status(404).send({error:"User not found"});r.send({user:o})}))})},422:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Friend=void 0;const s=i(n(185)),a=new s.Schema({name:{type:String,required:!0},birthday:{type:Date,required:!0}}),d=new s.Schema({email:{type:String,required:!0,unique:!0},friends:[a]});d.virtual("id").get((function(){return this._id.toHexString()})),d.set("toJSON",{virtuals:!0}),a.virtual("id").get((function(){return this._id.toHexString()})),a.set("toJSON",{virtuals:!0}),d.methods.getFriend=function(e){return this.friends.find((t=>t._id.toString()===e))},t.Friend=s.default.model("Friend",a),t.default=s.default.model("User",d)},505:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(860));o(n(142)).default.config();const s=o(n(413)),a=o(n(433)),d=n(954),u=n(155),l=(0,i.default)();l.use(i.default.json());const c=n(582);l.use(c());const f=process.env.PORT||3e3;l.listen(f,(()=>{console.log(`Server is listening on port ${f}`)}));const h=new a.default,v=new s.default(h.getAllUsers);v.startDailyJob();const y=(0,d.UserController)(h),m=(0,u.FriendController)(h);l.post("/register",y.registerUser),l.get("/users/:email",y.getUserByEmail),l.post("/users/:userEmail/friends",m.addFriend),l.put("/users/:userId/friends/:friendId",m.updateFriend),l.post("/debug/send-emails",((e,t)=>r(void 0,void 0,void 0,(function*(){v.sendEmailsNow(),t.send({message:"Emails sent"})}))))},769:e=>{e.exports=require("@mailchimp/mailchimp_transactional/src/index.js")},582:e=>{e.exports=require("cors")},142:e=>{e.exports=require("dotenv")},860:e=>{e.exports=require("express")},185:e=>{e.exports=require("mongoose")},344:e=>{e.exports=require("node-schedule")}},t={};!function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(505)})();