(()=>{"use strict";var e={422:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Friend=void 0;const d=o(n(185)),s=new d.Schema({name:{type:String,required:!0},birthday:{type:Date,required:!0}}),u=new d.Schema({email:{type:String,required:!0,unique:!0},loginCode:{type:String,required:!0},loginCodeExpires:{type:Date},friends:[s]});u.methods.getFriend=function(e){return this.friends.find((t=>t._id.toString()===e))},t.Friend=d.default.model("Friend",s),t.default=d.default.model("User",u)},505:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t},d=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function d(e){try{u(r.next(e))}catch(e){o(e)}}function s(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(d,s)}u((r=r.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=s(n(860)),a=s(n(185)),l=o(n(422)),c=n(294);s(n(142)).default.config();const f=(0,u.default)(),p=n(582);f.use(p()),a.default.connect("mongodb://localhost/newsletter_app"),new c.NodeMailgun,f.use(u.default.json()),f.get("/",((e,t)=>{t.send("Hello, world!")}));const g=process.env.PORT||3e3;f.listen(g,(()=>{console.log(`Server is listening on port ${g}`)})),f.post("/register",((e,t)=>d(void 0,void 0,void 0,(function*(){console.log("register called");const{email:n}=e.body,r=yield l.default.findOne({email:n});if(r)return console.log("Existing user: "+r),void t.send({user:r});const i=Math.floor(1e5+9e5*Math.random()),o=new l.default({email:n,loginCode:i,loginCodeExpires:Date.now()+9e5});console.log("saving user"),yield o.save(),console.log("user saved"),o.id=o._id.toString(),t.send({user:o}),console.log("user email: "+o.email),console.log("user id: "+o._id.toString())})))),f.post("/users/:userEmail/friends",((e,t)=>d(void 0,void 0,void 0,(function*(){const{userEmail:n}=e.params,{name:r,birthday:i}=e.body;console.log("finding user with email: "+n);const o=yield l.default.findOne({email:n}),d=new l.Friend({name:r,birthday:i});d.id=d._id.toString(),o.friends.push(d),yield o.save();const s=o.toObject();s.id=s._id.toString(),delete s._id,delete s.loginCode,delete s.loginCodeExpires,t.send({message:"Friend added",userForClient:s})})))),f.put("/users/:userId/friends/:friendId",((e,t)=>d(void 0,void 0,void 0,(function*(){const{userId:n,friendId:r}=e.params,{name:i,birthday:o}=e.body,d=yield l.default.findById(n);if(!d)return t.status(404).send({error:"User not found"});const s=d.friends.find((e=>e.id===r));if(!s)return t.status(404).send({error:"Friend not found"});i&&(s.name=i),o&&(s.birthday=o),yield d.save(),t.send({message:"Friend updated",user:d})})))),f.get("/users/:userId",((e,t)=>d(void 0,void 0,void 0,(function*(){const{userId:n}=e.params,r=yield l.default.findById(n);if(!r)return t.status(404).send({error:"User not found"});t.send({user:r})}))))},582:e=>{e.exports=require("cors")},142:e=>{e.exports=require("dotenv")},860:e=>{e.exports=require("express")},185:e=>{e.exports=require("mongoose")},294:e=>{e.exports=require("ts-mailgun")}},t={};!function n(r){var i=t[r];if(void 0!==i)return i.exports;var o=t[r]={exports:{}};return e[r].call(o.exports,o,o.exports,n),o.exports}(505)})();